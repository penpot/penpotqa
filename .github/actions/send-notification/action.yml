name: 'Send Mattermost Notification'
description: 'Send test results notification to Mattermost'

inputs:
  mattermost-webhook-url:
    description: 'Mattermost webhook URL'
    required: true
  browser-name:
    description: 'Browser name for the notification'
    required: true
  folder-path:
    description: 'Test folder path (optional)'
    required: false
  is-manual-execution:
    description: 'Whether this is a manual execution (true/false)'
    required: false
    default: 'false'
  username:
    description: 'Username for manual execution mention'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Generate Mattermost message content
      id: message
      shell: bash
      run: |
        FOLDER_PATH="${{ inputs.folder-path }}"
        IS_MANUAL="${{ inputs.is-manual-execution }}"
        USERNAME="${{ inputs.username }}"

        # Generate the message content and save to output
        if [ -n "$FOLDER_PATH" ]; then
          if [ "$IS_MANUAL" = "true" ] && [ -n "$USERNAME" ]; then
            MESSAGE=$(npx ts-node -e "require('./helpers/mattermost.helper.js').generateMessage('${{ inputs.browser-name }}', '$FOLDER_PATH', true, '$USERNAME')")
          else
            MESSAGE=$(npx ts-node -e "require('./helpers/mattermost.helper.js').generateMessage('${{ inputs.browser-name }}', '$FOLDER_PATH', false, null)")
          fi
        else
          if [ "$IS_MANUAL" = "true" ] && [ -n "$USERNAME" ]; then
            MESSAGE=$(npx ts-node -e "require('./helpers/mattermost.helper.js').generateMessage('${{ inputs.browser-name }}', null, true, '$USERNAME')")
          else
            MESSAGE=$(npx ts-node -e "require('./helpers/mattermost.helper.js').generateMessage('${{ inputs.browser-name }}', null, false, null)")
          fi
        fi

        # Save message to output, handling multiline content
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "$MESSAGE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Send Mattermost notification
      if: always()
      uses: mattermost/action-mattermost-notify@v1
      with:
        MATTERMOST_WEBHOOK_URL: ${{ inputs.mattermost-webhook-url }}
        TEXT: ${{ steps.message.outputs.message }}
