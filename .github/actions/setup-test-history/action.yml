name: 'Setup Test History and Baseline'
description: 'Downloads test history from S3 for smart reporter'

inputs:
  aws-access-key-id:
    description: 'AWS Access Key ID'
    required: true
  aws-secret-access-key:
    description: 'AWS Secret Access Key'
    required: true
  aws-region:
    description: 'AWS Region'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: ${{ inputs.aws-region }}

    - name: Download test history from S3
      shell: bash
      run: |
        # Use branch-specific history files
        CLEAN_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/_/g')
        echo "ðŸ” Looking for test-history files for branch: ${CLEAN_BRANCH}"

        # Download test-history files specific to this branch
        mkdir -p "history/${CLEAN_BRANCH}"
        aws s3 sync s3://kaleidos-qa-reports/history/${CLEAN_BRANCH}/ history/${CLEAN_BRANCH}/ --exclude "*" --include "test-history*" 2>/dev/null || echo "No test-history files found for branch ${CLEAN_BRANCH}"

        # Find the largest test-history file for this branch (most complete)
        BEST_FILE=""
        BEST_SIZE=0

        for file in history/${CLEAN_BRANCH}/test-history*.json; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(wc -c < "$file")
            echo "ðŸ“„ Found: $file (${FILE_SIZE} bytes)"
            
            if [ "$FILE_SIZE" -gt "$BEST_SIZE" ]; then
              BEST_FILE="$file"
              BEST_SIZE="$FILE_SIZE"
            fi
          fi
        done

        if [ -n "$BEST_FILE" ]; then
          echo "âœ… Using: $BEST_FILE"
          cp "$BEST_FILE" test-history.json
          echo "ðŸ“Š Branch-specific history loaded for: ${CLEAN_BRANCH}"
        else
          echo "â„¹ï¸ No test-history files found for branch ${CLEAN_BRANCH}, smart reporter will start fresh"
        fi
